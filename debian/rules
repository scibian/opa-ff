#!/usr/bin/make -f

BUILDDIR=$(CURDIR)/OpenIb_Host/BUILD
DESTDIR=$(CURDIR)/debian/tmp
LIBDIR=/usr/lib/$(DEB_HOST_MULTIARCH)
DSAP_LIBDIR=$(LIBDIR)

%:
	dh $@ --parallel

.PHONY: override_dh_auto_clean
override_dh_auto_clean:

.PHONY: override_dh_auto_configure
override_dh_auto_configure:

.PHONY: override_dh_auto_build
override_dh_auto_build:
	mkdir $(BUILDDIR)
	cd OpenIb_Host && OPA_FEATURE_SET=opa10 ./ff_build.sh $(BUILDDIR)

.PHONY: override_dh_strip
override_dh_strip:
	dh_strip --dbg-package=opa-dbg

.PHONY: override_dh_auto_test
override_dh_auto_test:

.PHONY: override_dh_auto_install
override_dh_auto_install:
	BUILDDIR=$(BUILDDIR) DESTDIR=$(DESTDIR) LIBDIR=$(LIBDIR) DSAP_LIBDIR=$(DSAP_LIBDIR) ./OpenIb_Host/ff_install.sh
	install -D -m 0644 debian/etc/intel-opa.sh $(DESTDIR)/etc/profile.d/intel-opa.sh
	find $(DESTDIR)/usr -type f \( \
		-name '*.[ch]' \
		-o -name '*.xlsx' \
		\) -exec chmod 0644 {} \;
# libopamgt.so and variants always get installed to usr/lib by the install script
	mv $(DESTDIR)/usr/lib/libopamgt.* $(DESTDIR)/$(LIBDIR)
	ln -s libopamgt.so.0.4.0 $(DESTDIR)/$(LIBDIR)/libopamgt.so.0


